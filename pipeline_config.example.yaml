# Example Pipeline Configuration for seq_sim orchestrate command
# This file demonstrates all available configuration options

# NOTE: Only edit values, please!

# ============================================================================
# seqSim v0.1 PIPELINE OVERVIEW
# ============================================================================
# This pipeline consists of two main workflows:
#
# MAIN PIPELINE (Variant Simulation):
# 1. align-assemblies:          Align query assemblies to reference using AnchorWave
# 2. maf-to-gvcf:               Convert MAF alignment files to compressed GVCF format
# 3. downsample-gvcf:           Downsample variants at specified rates per chromosome
# 4. convert-to-fasta:          Generate FASTA files from downsampled variants
# 5. align-mutated-assemblies:  Realign mutated FASTA files back to reference
#
# RECOMBINATION PIPELINE (Generate Recombinant Genomes):
# 6. pick-crossovers:           Simulate crossover events in reference coordinates
# 7. create-chain-files:        Convert MAF files to chain format for coordinate conversion
# 8. convert-coordinates:       Convert crossover points to assembly coordinates
# 9. generate-recombined-sequences: Create recombined FASTA files from parent assemblies
# 10. format-recombined-fastas: Format recombined FASTA files with consistent line widths
#
# NOTE: Environment setup is automatic! The orchestrate command will automatically
#       detect if the working directory and required tools (MLImpute, biokotlin-tools)
#       are missing and run setup-environment for you. No manual setup required!
# ============================================================================

# Optional: Working directory for the pipeline (defaults to "seq_sim_work")
# The orchestrate command will create this and set up tools automatically if needed
work_dir: "seq_sim_work"

# Optional: Specify which pipeline steps to execute
# If omitted, all configured steps will be executed
# To skip a step, comment it out with '#' at the beginning of the line
run_steps:
  # Main Pipeline (Variant Simulation)
  - align_assemblies               # Step 01: Align original assemblies
  - maf_to_gvcf                    # Step 02: Convert alignments to GVCF
  - downsample_gvcf                # Step 03: Downsample variants
  - convert_to_fasta               # Step 04: Generate mutated FASTA files
  - align_mutated_assemblies       # Step 05: Realign mutated sequences

  # Recombination Pipeline (Generate Recombinant Genomes)
  - pick_crossovers                # Step 06: Pick crossover points
  - create_chain_files             # Step 07: Create coordinate conversion chains
  - convert_coordinates            # Step 08: Convert coordinates to assembly space
  - generate_recombined_sequences  # Step 09: Generate recombined sequences
  - format_recombined_fastas       # Step 10: Format recombined FASTA files

# ============================================================================
# MAIN PIPELINE CONFIGURATION (Steps 1-5)
# ============================================================================

# Step 1: Align Assemblies
# Aligns query assemblies to a reference using AnchorWave and minimap2
# Required to start the pipeline (unless using previous outputs)
align_assemblies:
  ref_gff: "path/to/reference.gff"      # Required: Reference GFF annotation file
  ref_fasta: "path/to/reference.fa"     # Required: Reference FASTA file
  query_fasta: "path/to/queries.txt"    # Required: Single query file, directory, or text list
  threads: 1                            # Optional: Number of threads (default: 1)

# Step 2: MAF to GVCF Conversion
# Converts MAF files from align_assemblies to compressed GVCF format
# Automatically uses ref_fasta from align_assemblies and MAF output paths
maf_to_gvcf:
  sample_name: "optional_sample_name"   # Optional: Override sample name in GVCF

# Step 3: Downsample GVCF
# Downsamples GVCF files at specified rates per chromosome
# Automatically uses GVCF output directory from maf_to_gvcf
downsample_gvcf:
  ignore_contig: ""                     # Optional: Comma-separated patterns to ignore
  rates: "0.01,0.05,0.1,0.15,0.2"       # Optional: Comma-separated downsampling rates
  seed: 42                              # Optional: Random seed for reproducibility
  keep_ref: true                        # Optional: Keep reference blocks (default: true)
  min_ref_block_size: 20                # Optional: Minimum ref block size (default: 20)

# Step 4: Convert to FASTA
# Converts downsampled GVCF files to FASTA format
# Automatically uses ref_fasta from align_assemblies and GVCF output from downsample_gvcf
convert_to_fasta:
  missing_records_as: "asRef"            # Optional: Missing records (asN, asRef, asNone)
  missing_genotype_as: "asN"             # Optional: Missing genotypes (asN, asRef, asNone)

# Step 5: Align Mutated Assemblies
# Realigns the mutated FASTA files from convert_to_fasta back to the reference
# Automatically uses ref_gff and ref_fasta from align_assemblies, and FASTA files from convert_to_fasta
# This creates a circular workflow where mutated sequences are realigned for comparison
align_mutated_assemblies:
  threads: 1                             # Optional: Number of threads (default: 1)

# ============================================================================
# RECOMBINATION PIPELINE CONFIGURATION (Steps 6-10)
# ============================================================================

# Step 6: Pick Crossovers
# Simulates crossover events to generate recombination breakpoints
# Uses MLImpute's pick_crossovers.py to simulate synthetic recombinant genomes
# Generates two populations: landrace (1250 rounds) and two-parent cross (1 round)
pick_crossovers:
  assembly_list: "path/to/assembly_list.txt"  # Required: Tab-separated file with assembly paths and names
                                              # Format: <path><TAB><name> (one per line)
                                              # Example:
                                              # /path/to/assembly1.fa<TAB>parent1
                                              # /path/to/assembly2.fa<TAB>parent2

# Step 7: Create Chain Files
# Converts MAF alignment files to UCSC chain format for coordinate conversion
# Automatically uses MAF files from align_assemblies (step 1)
# Uses maf-convert tool (automatically downloaded if missing)
create_chain_files:
  jobs: 8                                # Optional: Number of parallel jobs (default: 8)

# Step 8: Convert Coordinates
# Converts crossover breakpoints from reference coordinates to assembly coordinates
# Automatically uses refkey files from pick_crossovers and chain files from create_chain_files
# Uses CrossMap for coordinate conversion via chain files
convert_coordinates:
  assembly_list: "path/to/assembly_list.txt"  # Required: Same assembly list as pick_crossovers

# Step 9: Generate Recombined Sequences
# Creates recombined FASTA sequences by concatenating segments from parent assemblies
# Automatically uses founder key files from convert_coordinates
# Each founder gets its own recombined FASTA file
generate_recombined_sequences:
  assembly_list: "path/to/assembly_list.txt"      # Required: Same assembly list as above
  chromosome_list: "path/to/chromosome_list.txt"  # Required: Text file with chromosome names (one per line)
                                                  # Example:
                                                  # chr1
                                                  # chr2
                                                  # chr3
  assembly_dir: "path/to/parent_assemblies/"      # Required: Directory containing parent assembly FASTA files
                                                  # Files should be named to match assembly_list names
                                                  # Example: parent1.fa, parent2.fa

# Step 10: Format Recombined Fastas
# Reformats recombined FASTA files to have consistent line widths using seqkit
# Automatically uses recombined FASTA files from generate_recombined_sequences
# Ensures compatibility with downstream tools
format_recombined_fastas:
  line_width: 60                         # Optional: Characters per line (default: 60)
  threads: 8                             # Optional: Number of threads (default: 8)

# ============================================================================
# Usage Examples:
# ============================================================================
#
# 1. Run the full pipeline (all configured steps):
#    ./gradlew run --args="orchestrate --config pipeline_config.yaml"
#    Note: Environment setup runs automatically if needed on first run!
#
# 2. Run only the main pipeline (variant simulation, steps 1-5):
#    run_steps:
#      - align_assemblies
#      - maf_to_gvcf
#      - downsample_gvcf
#      - convert_to_fasta
#      - align_mutated_assemblies
#      # Comment out recombination steps
#
# 3. Run only the recombination pipeline (steps 1, 6-10):
#    run_steps:
#      - align_assemblies          # Required for MAF files
#      # - maf_to_gvcf              # Skip GVCF steps
#      # - downsample_gvcf
#      # - convert_to_fasta
#      # - align_mutated_assemblies
#      - pick_crossovers
#      - create_chain_files
#      - convert_coordinates
#      - generate_recombined_sequences
#      - format_recombined_fastas
#
# 4. Run steps 1-2-4-5 (skip downsampling):
#    run_steps:
#      - align_assemblies
#      - maf_to_gvcf
#      # - downsample_gvcf          # Commented out
#      - convert_to_fasta           # Will use maf_to_gvcf outputs
#      - align_mutated_assemblies
#
# 5. Rerun only format step (requires previous outputs):
#    run_steps:
#      # Comment out all previous steps
#      - format_recombined_fastas   # Only this will run
#
# ============================================================================
# IMPORTANT NOTES:
# ============================================================================
#
# Assembly List Format:
# - Tab-separated file with two columns: path and name
# - Must have an EVEN number of assemblies (for parent pairing)
# - Example:
#   /data/assemblies/B73.fa<TAB>B73
#   /data/assemblies/Mo17.fa<TAB>Mo17
#   /data/assemblies/W22.fa<TAB>W22
#   /data/assemblies/PH207.fa<TAB>PH207
#
# Chromosome List Format:
# - Plain text file with one chromosome name per line
# - Names should match chromosome names in assemblies
# - Example:
#   chr1
#   chr2
#   chr3
#
# Recombination Pipeline Dependencies:
# - Step 6 (pick_crossovers) requires: ref_fasta from step 1
# - Step 7 (create_chain_files) requires: MAF files from step 1
# - Step 8 (convert_coordinates) requires: outputs from steps 6 and 7
# - Step 9 (generate_recombined_sequences) requires: output from step 8
# - Step 10 (format_recombined_fastas) requires: output from step 9
#
# ============================================================================
